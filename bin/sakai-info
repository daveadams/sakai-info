#!/usr/bin/env ruby
#
# sakai-info
#   Command line tool for exploring the Sakai database via the
#   sakai-info library
#
# Created 2012-02-15 daveadams@gmail.com
# Last updated 2012-02-24 daveadams@gmail.com
#
# https://github.com/daveadams/sakai-info
#
# This software is public domain.
#

require 'sakai-info'
include SakaiInfo

require 'sakai-info/cli'

ObjectModes = %w(site user)

flags = []
args = []
db_name = nil

while arg = ARGV.shift
  if arg =~ /^-/
    if arg == "-D"
      db_name = ARGV.shift
    elsif arg =~ /^--database=/
      db_name = arg.split("=")[1]
    else
      flags << arg
    end
  else
    args << arg
  end
end

if args.length < 1
  STDERR.puts "ERROR: No command was given."
  STDERR.puts "Run '#{File.basename($0)} help' for a list of commands."
  exit 1
end

case args[0]
when "help" then
  if not args[1].nil?
    CLI::Help.help args[1]
  else
    CLI::Help.help
  end
  exit

when "version" then
  puts VERSION
  exit

when "test" then
  DB.load_config
  success = 0
  failure = 0
  dbs = nil

  if db_name.nil?
    dbs = DB.databases
  else
    dbs = { db_name => DB.databases[db_name] }
  end

  dbs.each do |nickname, connection_string|
    begin
      print "Trying #{nickname}... "; STDOUT.flush
      db = Sequel.connect(connection_string)
      if db.test_connection
        puts "OK"
        success += 1
      else
        puts "FAIL"
        failure += 1
      end
    rescue => e
      puts "FAIL"
      puts "  #{e}"
      failure += 1
    end
  end

  if failure > 0
    puts "WARNING: Some connections failed"
    exit 1
  else
    puts "OK: All connection tests succeeded"
    exit
  end

else
  # test to see if it's an accepted object mode
  if ObjectModes.include? args[0]
    mode = args.shift

  else
    STDERR.puts "ERROR: Command '#{args[0]}' was not recognized."
    STDERR.puts "Run '#{File.basename($0)} help' for a list of commands."
    exit 1
  end
end

# load database config and set instance to the instance given on the command line
DB.load_config
if not db_name.nil?
  DB.default_database = db_name
end

puts flags.inspect

if mode == "user"
  case args[0]
  when "count" then
    puts User.count
  else
    puts User.find(args[0]).to_yaml
  end

elsif mode == "site"
  case args[0]
  when "count" then
    puts Site.count
  else
    puts Site.find(args[0]).to_yaml
  end
end

