#!/usr/bin/env ruby
#
# sakai-info
#   Command line tool for exploring the Sakai database via the
#   sakai-info library
#
# Created 2012-02-15 daveadams@gmail.com
# Last updated 2012-02-24 daveadams@gmail.com
#
# https://github.com/daveadams/sakai-info
#
# This software is public domain.
#

require 'sakai-info'
include SakaiInfo

require 'sakai-info/cli'

ObjectModes = %w(site user)

if ARGV.length > 0
  case ARGV[0]

  when "help" then
    if ARGV.length > 1
      CLI::Help.help ARGV[1]
    else
      CLI::Help.help
    end
    exit

  when "version" then
    puts VERSION
    exit

  when "validate" then
    if DB.load_config
      puts "Configuration OK"
      exit
    else
      exit 1
    end

  when "test" then
    STDERR.puts "PENDING: test mode unimplemented"
    exit 1

  else
    # test to see if it's an accepted object mode
    if ObjectModes.include? ARGV[0]
      mode = ARGV[0]
      ARGV.shift
      # continue on
      DB.load_config

    else
      STDERR.puts "ERROR: Command '#{ARGV[0]}' was not recognized."
      STDERR.puts "Run 'sakai-info help' for a list of commands."
      exit 1
    end
  end
else
  STDERR.puts "ERROR: No command was given."
  STDERR.puts "Run 'sakai-info help' for a list of commands."
  exit 1
end

if mode == "user"
  case ARGV[0]
  when "count" then
    puts User.count
  when "sites" then
    puts User.find(ARGV[1]).to_yaml(:default, :membership)
  else
    puts User.find(ARGV[0]).to_yaml
  end

elsif mode == "site"
  case ARGV[0]
  when "count" then
    puts Site.count
  else
    puts Site.find(ARGV[0]).to_yaml(:summary)
  end
end

